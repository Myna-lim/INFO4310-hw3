<html>
    <h5 style="margin-bottom: 0px">Carly Hu (ch862) & Myna Lim (ml2326) HW 3</h5>
    <h1 style="margin-top: 10px; margin-bottom: 0px;"> FoodE </h1>
    <head>
        <script src="https://d3js.org/d3.v7.min.js"></script>
        <script src="https://d3js.org/topojson.v3.min.js"></script>
        <script src='neighborhoods.js'></script> <!-- Boston map from a different source 
        https://github.com/maptimeBoston/d3-maptime/blob/gh-pages/example6/neighborhoods.js -->
    </head>
    <style>
        * {
            font-family:Verdana, Geneva, Tahoma, sans-serif;
        }

        body{
          padding: 20px;
          background-color: #aeccfc;
 
        }
        .neighbor_outline {
          fill: none;
          stroke: white;
          stroke-width: 0.6px;
        }

        .choropleth{
            margin-top: 0px;
        }
        .filter{
          height: 300;
          width: 500;
          padding: 20;
        }
        .right-panel{
          display: flex;
          flex-direction: column;
        }
        .all{
          display: flex;
          flex-direction: row;
        }
        .category{
          padding: 10px;
          margin: 5px;
          border-radius: 10px;
        }
        .foodcategory-bar{
          display: flex;
          
        }
    </style>

    <body>

        <p id="1_vis">
          <div class = "all" >
            <svg id="choropleth" height="670" width="900" style="margin:10px; background-color:aliceblue; border-radius: 8px;" ></svg>
            <div class = "right-panel">
              <div id="filter" class = "filter">
                <h3> filter results:</h3>
                <div id = "foodcategory-bar"> </div>
                <div id = "rating-bar"> </div>
              </div>
              <svg id="panel" height="300" width="500"  style="margin: 20px; padding-top: 20px; border-radius: 8px; background-color: aliceblue; visibility: hidden" ></svg>
            </div>
          </div>
            
          <script>
            const svg = d3.select("#choropleth");
            const map = svg.append("g");
            const width = svg.attr("width");
            const height = svg.attr("height");
            const margin = { top: 100, right: 20, bottom: 20, left:0};
            const mapWidth = width - margin.left - margin.right;
            const mapHeight = height - margin.top - margin.bottom;

            let annotations = svg.append("g").attr("id","annotations");

            var projection = d3.geoAlbers()
                                        .scale(190000)
                                        .rotate([71.057, 0])
                                        .center([0, 42.313])
                                        .translate([width/2, height/2]);

            var path = d3.geoPath().projection(projection);
            map.selectAll('path')
                    .data(neighborhoods_json.features)
                    .enter()
                    .append('path')
                    .attr('fill', '#ccc')
                    .attr('d', path)
                    .style("stroke", "black")
                    .style("stroke-width", ".8px")

            
            const requestData = async function() {
                let yelp = await d3.csv('yelp_boston_preprocess.csv');

              
                yelp.forEach( (d, i) => {
                        d.position = projection( [d.longitude, d.latitude] );
                        
                        });

                // let restaurants = map.selectAll("circle")
                //     .data(yelp)
                //     .join("circle")
                //     .attr("class", "circle")
                //     .attr("cx", d => d.position[0])
                //     .attr("cy", d => d.position[1])
                //     .attr("r", 10)
                //     .attr("opacity", 0.5)
                //     .attr("d", path)
                //     .style("fill",  "blue");

                let restaurants = map.selectAll(".circle")
                      .data(yelp)
                      .join("g")
                      .attr("class", "circle");

                  restaurants.append("circle")
                      .attr("cx", d => d.position[0])
                      .attr("cy", d => d.position[1])
                      .attr("r", 10)
                      .attr("opacity", 0.5)
                      .attr("d", path)
                      .style("fill", "darkblue");

                  let texts = map.selectAll("text")
                    .data(yelp)
                    .join("g")
                    .append("text")
                    .attr("x", d => d.position[0]) 
                    .attr("y", d => d.position[1]) 
                    .text(d => d.rating) 
                    .attr("fill", "white")
                    .attr("font-size", 13) 
                    .style("text-anchor", "middle")
                    .attr("class", "text");
                    
                  

                
                    
                            
                var zoom = d3.zoom()
                            .scaleExtent([1,20])
                            .translateExtent([[-50,-50],[mapWidth+50,mapHeight+50]])
                            .on("zoom", mapZoomed);

                map.call(zoom);
                map.call(zoom.transform, d3.zoomIdentity); 
                
                function mapZoomed({transform}) {      
                      map.attr("transform", transform.toString() );

                      map.select(".state-outline")
                                  .style("stroke-width", 2 / transform.k);
                      map.select(".county-outline")
                                  .style("stroke-width", 1 / transform.k)

                      map.select(".county-outline")
                                  .attr("visibility", (transform.k > 3) ? "visible" : "hidden");
                      map.selectAll(".county")
                                  .attr("visibility", (transform.k > 3) ? "visible" : "hidden");}
                
                  function call_transformk(){
                      return d3.zoomTransform(map.node()).k;
                  }
                
           // FILTERING PANEL

               foodCategories = ['all', 'cafe', 'american', 'asian', 'mexican', 'european',
                  'ethnicmarkets', 'other']

               foodCategories.forEach(d => {

                  d3.select("div#foodcategory-bar")
                    .append("button")
                    .attr("class", "category")
                    .attr("id", `${d}`)
                    .text(d)
                    .on("click", function () {
                      d3.selectAll("button.category").style('background-color', "aliceblue").style("border-color", "white").style("border-style","none");
                      d3.select(this).style("background-color", "#80acf2")
                      if (d === "all"){
                        all_map();
                      }
                      updateMap(d);
                     })
                   })

                   d3.select("#all").dispatch("click");

                let images = map.selectAll("image")

                function updateMap(foodCategory) {
                    const circles = map.selectAll("circle");
                    //const texts = map.selectAll("text");
                    circles.attr("visibility", "hidden");
                    texts.attr("visibility", "hidden");
                    if (foodCategory === 'all'){
                        all_map("visible");
                    }
                    else{
                        all_map("hidden");
                        circles.filter(d => d["search_category"] === foodCategory)
                        .attr("visibility", "visible");
                        texts.filter(d => d["search_category"] === foodCategory).attr("visibility", "visible")};
                
                        var zoom1 = d3.zoom()
                            .scaleExtent([1,20])
                            .translateExtent([[-50,-50],[mapWidth+50,mapHeight+50]])
                            .on("zoom", mapZoomed1);

                        map.call(zoom1);
                        map.call(zoom1.transform, d3.zoomIdentity); 
                        
                        function mapZoomed1({transform}) {      
                              map.attr("transform", transform.toString() );

                              map.select(".state-outline")
                                          .style("stroke-width", 2 / transform.k);
                              map.select(".county-outline")
                                          .style("stroke-width", 1 / transform.k)

                              map.select(".county-outline")
                                          .attr("visibility", (transform.k > 3) ? "visible" : "hidden");
                              map.selectAll(".county")
                                          .attr("visibility", (transform.k > 3) ? "visible" : "hidden");
                              circles.attr("r", 15 / transform.k);
                              texts.attr("font-size", 13/transform.k);
                              texts.attr("y", d => (d.position[1]+((15/transform.k)))-(10/transform.k));
                              images.attr("width", 30/transform.k).attr("height", 30/transform.k);
                        }
                      }
                
                // function to show image icons instead of dots
                function all_map(visibility) {
                    let images = map.selectAll("image")
                        .data(yelp)
                        .join("image")
                        .attr("xlink:href", d => {
                            const categoryToImageUrl = {
                                'cafe': 'coffee-cup.png',
                                'american': 'burger.png',
                                'asian': 'noodles.png',
                                'mexican': 'taco.png',
                                'european': 'pizza.png',
                                'ethnicmarkets': 'market.png',
                                'other': 'restaurant.png'
                            };
                            return categoryToImageUrl[d.search_category];
                        })
                        .attr("width", 30)
                        .attr("height", 30)
                        .attr("opacity", .6)
                        .attr("x", d => d.position[0]-15)
                        .attr("y", d => d.position[1]-15)
                        .attr("visibility", visibility);

                        var zoom1 = d3.zoom()
                            .scaleExtent([1,20])
                            .translateExtent([[-50,-50],[mapWidth+50,mapHeight+50]])
                            .on("zoom", mapZoomed1);

                        map.call(zoom1);
                        map.call(zoom1.transform, d3.zoomIdentity); 
                        
                        function mapZoomed1({transform}) {      
                              map.attr("transform", transform.toString() );

                              map.select(".state-outline")
                                          .style("stroke-width", 2 / transform.k);
                              map.select(".county-outline")
                                          .style("stroke-width", 1 / transform.k)

                              map.select(".county-outline")
                                          .attr("visibility", (transform.k > 3) ? "visible" : "hidden");
                              map.selectAll(".county")
                                          .attr("visibility", (transform.k > 3) ? "visible" : "hidden");
                              map.selectAll("image").attr("height", 30 / transform.k).attr("width", 30 / transform.k);}
                      
                }
            // RESTAURANT-SPECIFIC PANEL
                
                // hover functionality --> shows restaurant name
  
                let label = map.append("text").attr("visibility","hidden")    

                    // for dots
                    restaurants.attr("class", "data_hover");
                    texts.attr("class", "data_hover");

                    d3.selectAll(".data_hover").on("mouseover", function() {
                        d3.select(this).attr("opacity", 1).attr("r", 20 / call_transformk());
                        let name = d3.select(this).datum()["name"]

                        label.text(name) 
                            .attr("x", (d3.select(this).datum().position[0]) + 25/call_transformk()) 
                            .attr("y",(d3.select(this).datum().position[1]) + 5/call_transformk())
                            .attr("visibility", "visible")
                            .style("font-weight", "bold")
                            .style("background-color", "white")
                            .style("font-size", 15/call_transformk())
                    });
                    d3.selectAll(".data_hover").on("mouseout", function() {
                        d3.select(this).attr("opacity",0.5).attr("r", 15 / call_transformk());
                        label.text(""); 
                    });   


                    // for images 
                    images.on("mouseover", function() {
                        d3.select(this).attr("opacity", 1)
                        let name = d3.select(this).datum()["name"]
                        label.text(name) 
                            .attr("x", (d3.select(this).datum().position[0]) + 35/call_transformk()) 
                            .attr("y",(d3.select(this).datum().position[1]) + 20/call_transformk())
                            .attr("visibility", "visible")
                            .style("font-weight", "bold")
                            .style("background-color", "white")
                            .style("font-size", 15/call_transformk())
                    });
                    images.on("mouseout", function() {
                        d3.select(this).attr("opacity",0.6)
                        label.text(""); 
                    });   

                // click functionality --> triggers info panel
                d3.selectAll(".data_hover").on("click", function() {
                        
                        let panel = d3.select("#panel")
                        panel.selectAll("text").remove()
                        panel.style("visibility","visible")

                        let name = d3.select(this).datum()["name"]

                        label.text(name) 
                            .attr("x", (d3.select(this).datum().position[0] + 25/call_transformk()) ) 
                            .attr("y",(d3.select(this).datum().position[1]) + 5/call_transformk())
                            .attr("visibility", "visible")
                            .style("font-weight", "bold")
                            .style("background-color", "white")
                       
                        restaurant = d3.select(this).datum()
                        let address = JSON.parse(restaurant["location_json"])['display_address'].join(", ")

                        let info = panel.append("text")

                        info.text(restaurant["name"]).attr("x", 20).attr("y", 30).style("font-weight", "bold").style("font-size", 30)
                        info.append("tspan").text(restaurant["rating"]) // TODO: translate to stars
                        .attr("x", 20).attr("dy", "2em").style("font-weight", "lighter").style("font-size", 15);
                        info.append("tspan").text(restaurant["neighborhood"]).attr("x", 20).attr("dy", "2em").style("font-weight", "lighter").style("font-size", 15)
                        info.append("tspan").text(address).attr("x", 20).attr("dy", "2em").style("font-weight", "lighter").style("font-size", 15)
                        info.append("tspan").text(JSON.parse(restaurant["categories_json"])[0][0])
                        .attr("x", 20).attr("dy", "2em").style("font-weight", "lighter").style("font-size", 15).style("font-style", "italic")
                        info.append("a").attr("xlink:href", restaurant["url"]) 
                        .append("tspan").text(restaurant["url"]).attr("x", 20).attr("dy", "2em").style("font-weight", "lighter").style("font-size", 15).style("fill", "blue")
                    })

                    images.on("click", function() {
                        let panel = d3.select("#panel")
                        panel.selectAll("text").remove()
                        panel.style("visibility","visible")

                        let name = d3.select(this).datum()["name"]

                        label.text(name) 
                            .attr("x", (d3.select(this).datum().position[0] + 35/call_transformk()) ) 
                            .attr("y",(d3.select(this).datum().position[1]) + 20/call_transformk())
                            .attr("visibility", "visible")
                            .style("font-weight", "bold")
                            .style("background-color", "white")
                       
                        restaurant = d3.select(this).datum()
                        let address = JSON.parse(restaurant["location_json"])['display_address'].join(", ")

                        let info = panel.append("text")
                        info.text(restaurant["name"]).attr("x", 20).attr("y", 30).style("font-weight", "bold").style("font-size", 30)
                        info.append("tspan").text(restaurant["rating"]) // TODO: translate to stars
                        .attr("x", 20).attr("dy", "2em").style("font-weight", "lighter").style("font-size", 15);
                        info.append("tspan").text(restaurant["neighborhood"]).attr("x", 20).attr("dy", "2em").style("font-weight", "lighter").style("font-size", 15)
                        info.append("tspan").text(address).attr("x", 20).attr("dy", "2em").style("font-weight", "lighter").style("font-size", 15)
                        info.append("tspan").text(JSON.parse(restaurant["categories_json"])[0][0])
                        .attr("x", 20).attr("dy", "2em").style("font-weight", "lighter").style("font-size", 15).style("font-style", "italic")
                        info.append("a").attr("xlink:href", restaurant["url"]) 
                        .append("tspan").text(restaurant["url"]).attr("x", 20).attr("dy", "2em").style("font-weight", "lighter").style("font-size", 15).style("fill", "blue")

                    })
                   
            } 
            requestData();
          </script>
      </p>
    </body>
</html>